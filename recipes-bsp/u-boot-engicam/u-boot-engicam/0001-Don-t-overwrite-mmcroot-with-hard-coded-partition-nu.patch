From c790ea658b92d9f2d5b278527dadee68d5ee3d1f Mon Sep 17 00:00:00 2001
From: Simone Tellini <simone.tellini@robomagister.com>
Date: Thu, 5 Oct 2023 15:13:09 +0000
Subject: [PATCH] Don't overwrite mmcroot with hard-coded partition number when
 booting from dev 2 (internal eMMC)

---
 board/freescale/common/mmc.c | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/board/freescale/common/mmc.c b/board/freescale/common/mmc.c
index ab1652d697..58a6df023a 100644
--- a/board/freescale/common/mmc.c
+++ b/board/freescale/common/mmc.c
@@ -33,7 +33,7 @@ __weak int mmc_map_to_kernel_blk(int dev_no)
 void board_late_mmc_env_init(void)
 {
 	char cmd[32];
-	char mmcblk[32];
+	char mmcblk[64];
 	u32 dev_no = mmc_get_env_dev();
 
 	if (!check_mmc_autodetect())
@@ -41,9 +41,9 @@ void board_late_mmc_env_init(void)
 
 	env_set_ulong("mmcdev", dev_no);
 
-	/* Set mmcblk env */
-	sprintf(mmcblk, "/dev/mmcblk%dp2 rootwait rw",
-		mmc_map_to_kernel_blk(dev_no));
+	/* Set mmcblk env - use variable partition number when booting from the internal eMMC */
+	sprintf(mmcblk, "/dev/mmcblk%dp%s rootwait rw",
+		mmc_map_to_kernel_blk(dev_no), ( dev_no == 1 ) ? "2" : "${mmcpart}");
 	env_set("mmcroot", mmcblk);
 
 	sprintf(cmd, "mmc dev %d", dev_no);
